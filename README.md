# highload-mail.ru

## Содержание

* ### [Тема и целевая аудитория](#1)
* ### [Расчет нагрузки](#2)

## 1. Тема и целевая аудитория <a name="1"></a>

**Mail.ru** — почтовый сервис, с возможностью чтения и отправки (с вложениями) писем.

### MVP

- Авторизация
- Просмотр почтового ящика
- Чтение писем
- Отправка писем
- Удаление письма

### Целевая аудитория

- Россия, страны СНГ
- Месячная аудитория 51 млн человек (+6% относительно 2021 года) [^1]
- Дневная аудитория 25 млн пользователей [^2]

## 2. Расчет нагрузки <a name="2"></a>

### Продуктовые метрики <a name="prods"></a>

* Месячная аудитория - 51 млн человек [^1]
* Дневная нагрузка - 25 млн человек [^2]
* Количество активных акквунтов - 120 млн человек [^3] (~68% населения РФ)
* Средний размер хранилища пользователя:

 1. Чтение писем. Предположим, что пользователь читает 12 писем за день. Около 50% всех писем [^4] содержат вложения, из которых 80% это фотографии, 19% - документы и 1 % - видеофайлы и архивы. При этом, каждое пятое письмо содержит два и более вложений. Получается, что в среднем пользователь прочитывает 6 писем без вложений (размер такого письма 4 кб), 2 письма - с двумя и более вложениями (~800 кб) и 4 письма с одним вложением (~400кб)

| Письма без сложений | Письма с вложением| Письма с вложениями |Итого|  
| ------------- |:------------------:| -----:| -----:|
|       24кб   | 1600кб    | 1600кб |3,223 мб|

2. Просмотр почтового ящика. За один визит пользователь просматривает ~6 страниц [^5] почтового ящика (50 писем на каждой странице). Размер одного письма в данном случае - 9.3 кб, получается 

```
  6 страниц * 50 писем * 9.3 кб = 2,79 мб
```
3. Отправка писем. В среднем пользователь пишет 5 писем в день. Исходя из данных п.1, получаем

| Письма без сложений | Письма с вложением| Письма с вложениями |Итого|  
| ------------- |:------------------:| -----:| -----:|
|      8 кб   | 800кб    | 800кб |1,608 мб|

Итого, 

| Чтение писем | Проверка почтового ящика| Написание писем |Итого|  
| ------------- |:------------------:| -----:| -----:|
|       3,223 мб   | 2,79 мб  | 1,608 мб | 7,621 мб|

#### Среднее количество действий пользователя по типам в день
За февраль 2022 года почту mail.ru посетило 2.09 млрд человека со средним временем сессии - 8 минут. За это время пользователь просматривает ~8 страниц.
##### Авторизация
Пользователь заходит на почту 15 раз за день [^6], следовательно, понадобиться 15 запросов, чтобы проверить авторизован ли он или нет
##### Просмотр почтового ящика
Так же, учитывая данные выше, понадобится 15 запросов на получение последних писем.
##### Чтение писем
За сутки в среднем пользователь прочитает около 12 писем, соответсвенно 12 запросов, чтобы открыть и прочитать каждое письмо
##### Отправка писем
Пользователь пишет около 5 сообщений в день, следовательно, 5 запросов на отпрвку письма
##### Удаление писем
По статистике за год каждый пользователь получает 11680 писем в год [^7], в день получается - 32 письма. 50% из них - спам [^8]. Получается, что из 32 писем - 16 писем удаляются. Соотвественно нужно 16 запросов на удаление писем.
| Авторизация | Просмотр почтового ящика| Чтение писем |Отправка писем| Удаление писем |Итого|
| ------------- |:------------------:| -----:| -----:| -----:| -----:|
|     15   | 15    | 12 |5| 16 |63|

### Технические метрики

#### Размер хранения в разбивке по типам данных (в Тб) - для существенных блоков данных.
Существенные блоки - получение почтового ящика, чтение писем, написание писем

```
  Получение почтового ящика = (возьмем месячную нагрузка за действующую) 51 * 10^6 * 2,79 мб / 1024 / 1024 = 135,7 Тб
```
```
  Чтение писем = (возьмем месячную нагрузка за действующую) 51 * 10^6 * 3,223 мб / 1024 / 1024 = 156,8 Тб
```
```
  Написание писем = (возьмем месячную нагрузка за действующую) 51 * 10^6 * 1,608 мб / 1024 / 1024 = 78,2 Тб
```
#### Сетевой трафик
```
  Трафик = (25 * 10^6 * 3,223 мб + 25 * 10^6 * 2,79 мб + 25 * 10^6 * 1,608 мб + 25 * 10^6 * 16 * 9.3 кб / 1024) / 24 /60 / 60 / 1024  = 2,19 Гб/c 
  Суточный: 189 216 Гб/сутки
```
#### RPS
| Тип запроса | RPS| 
| ------------- |:-----:|
|    Авторизация   | 3472  |
|    Просмотр почтового ящика   | 3472  |
|    Чтение писем   | 2777  |
|    Написание писем  | 1157  |
|    Удаление писем   | 3703  |
|    Итого   | 14581  |

## Список литературы
[^1]: [Ежемесячная аудитория Почты Mail.ru](https://vk.company/ru/press/releases/11388/)
[^2]: [Обзор Mail.ru Group](https://journal.tinkoff.ru/news/review-mail-ru-group/)
[^3]: [Количество активных аккаунтов](https://corp.mail.ru/ru/company/portal/)
[^4]: [Пользователи мобильной Почты](https://corp.mail.ru/ru/press/releases/10147/)
[^5]: [Количество просматриваемых страниц в почте](https://www.similarweb.com/website/mail.ru/#overview)
[^6]: [How to Spend Way Less Time on Email Every Day](https://hbr.org/2019/01/how-to-spend-way-less-time-on-email-every-day)
[^7]: [Количество писем в год](https://blog.mail.ru/email-forever/)
[^8]: [Спам и фишинг](https://securelist.ru/spam-and-phishing-in-2020/100408/)
